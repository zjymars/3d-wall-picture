<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>元数据显示测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        .metadata-item {
            display: flex;
            margin-bottom: 10px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .metadata-key {
            font-weight: bold;
            min-width: 120px;
            color: #555;
        }
        .metadata-value {
            flex: 1;
            color: #333;
        }
        .tag {
            display: inline-block;
            background: #e3f2fd;
            color: #1976d2;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            margin-right: 4px;
            margin-bottom: 4px;
        }
        .type-tag {
            background: #e8f5e8;
            color: #2e7d32;
        }
        .phrase-tag {
            background: #fff3e0;
            color: #f57c00;
        }
        .no-data {
            color: #999;
            font-style: italic;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background: #45a049;
        }
        .error {
            color: #f44336;
            background: #ffebee;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            color: #4caf50;
            background: #e8f5e8;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 元数据显示测试</h1>
        
        <div class="test-section">
            <h3>📊 测试说明</h3>
            <p>这个页面用于测试元数据字段是否正确显示。点击下面的按钮来测试不同的数据源。</p>
        </div>

        <div class="test-section">
            <h3>🎯 测试操作</h3>
            <button onclick="testLocalStorage()">测试本地存储数据</button>
            <button onclick="testIndexedDB()">测试IndexedDB数据</button>
            <button onclick="testAPI()">测试API数据</button>
            <button onclick="clearResults()">清空结果</button>
        </div>

        <div id="results"></div>
    </div>

    <script>
        // 测试本地存储数据
        async function testLocalStorage() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="test-section"><h3>📂 本地存储测试结果</h3><p>正在测试...</p></div>';
            
            try {
                // 模拟从localStorage获取数据
                const stored = localStorage.getItem('image_storage');
                const images = stored ? JSON.parse(stored) : [];
                
                if (images.length === 0) {
                    resultsDiv.innerHTML = '<div class="test-section"><h3>📂 本地存储测试结果</h3><div class="error">本地存储中没有图片数据</div></div>';
                    return;
                }
                
                const firstImage = images[0];
                displayImageMetadata(firstImage, '本地存储', resultsDiv);
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="test-section"><h3>📂 本地存储测试结果</h3><div class="error">测试失败: ${error.message}</div></div>`;
            }
        }

        // 测试IndexedDB数据
        async function testIndexedDB() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="test-section"><h3>🗄️ IndexedDB测试结果</h3><p>正在测试...</p></div>';
            
            try {
                // 这里需要实际的IndexedDB访问代码
                // 由于这是测试页面，我们模拟一个示例
                const mockImage = {
                    id: 'photo-14',
                    url: 'http://example.com/image.jpg',
                    title: '测试图片',
                    description: '这是一个测试图片',
                    date: '2025-01-01',
                    tags: ['测试', '示例'],
                    width: 1920,
                    height: 1080,
                    format: 'JPG',
                    source_website: 'dataset-3',
                    // 新增的元数据字段
                    filename: 'test_image.jpg',
                    original_filename: '地景建筑_0001.jpg',
                    unique_id: 14,
                    type_tags: ['住宅', '现代主义', '傍晚'],
                    phrase_tags: ['超写实照片，山坡上的现代住宅', '独特的半埋椭圆结构']
                };
                
                displayImageMetadata(mockImage, 'IndexedDB', resultsDiv);
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="test-section"><h3>🗄️ IndexedDB测试结果</h3><div class="error">测试失败: ${error.message}</div></div>`;
            }
        }

        // 测试API数据
        async function testAPI() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="test-section"><h3>🌐 API测试结果</h3><p>正在测试...</p></div>';
            
            try {
                const response = await fetch('http://192.10.222.123:8001/api/v1/external/dataset-images/14');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const apiImage = await response.json();
                displayImageMetadata(apiImage, 'API', resultsDiv);
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="test-section"><h3>🌐 API测试结果</h3><div class="error">测试失败: ${error.message}</div></div>`;
            }
        }

        // 显示图片元数据
        function displayImageMetadata(image, source, container) {
            const html = `
                <div class="test-section">
                    <h3>📋 ${source} - 图片元数据</h3>
                    <div class="success">✅ 成功获取数据</div>
                    
                    <div class="metadata-item">
                        <span class="metadata-key">文件名:</span>
                        <span class="metadata-value">${image.original_filename || '未知'}</span>
                    </div>
                    
                    <div class="metadata-item">
                        <span class="metadata-key">格式:</span>
                        <span class="metadata-value">${image.format || '未知'}</span>
                    </div>
                    
                    <div class="metadata-item">
                        <span class="metadata-key">图片尺寸:</span>
                        <span class="metadata-value">${image.width && image.height ? `${image.width} × ${image.height}` : '未知'}</span>
                    </div>
                    
                    <div class="metadata-item">
                        <span class="metadata-key">标签:</span>
                        <div class="metadata-value">
                            ${image.type_tags && image.type_tags.length > 0 
                                ? image.type_tags.map(tag => `<span class="tag type-tag">${tag}</span>`).join('')
                                : '<span class="no-data">无标签</span>'
                            }
                        </div>
                    </div>
                    
                    <div class="metadata-item">
                        <span class="metadata-key">描述性短语:</span>
                        <div class="metadata-value">
                            ${image.phrase_tags && image.phrase_tags.length > 0 
                                ? image.phrase_tags.slice(0, 3).map(tag => `<span class="tag phrase-tag">${tag}</span>`).join('')
                                : '<span class="no-data">无标签</span>'
                            }
                        </div>
                    </div>
                    
                    <div class="metadata-item">
                        <span class="metadata-key">原始数据:</span>
                        <div class="metadata-value">
                            <pre style="font-size: 10px; background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto;">${JSON.stringify(image, null, 2)}</pre>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        // 清空结果
        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        // 页面加载时自动测试API
        window.onload = function() {
            console.log('🔍 元数据显示测试页面已加载');
            // 自动测试API数据
            setTimeout(() => {
                testAPI();
            }, 1000);
        };
    </script>
</body>
</html>
